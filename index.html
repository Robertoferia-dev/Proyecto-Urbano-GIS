<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Visor UDP - Monter√≠a</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

    <link rel="stylesheet" href="Style.css"/>

</head>
<body>

    <header>
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M3 11l6-6 6 6-6 6-6-6z" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        <h1>Visor UDP - Monter√≠a</h1>
    </header>

    <div class="toolbar" id="filter-toolbar">
        <button id="filter-all" class="btn filter active" data-zone="All">Todas</button>
        <button id="filter-oriental" class="btn filter" data-zone="Oriente">Oriente</button>
        <button id="filter-occidental" class="btn filter" data-zone="Occidente">Occidente</button>
        <button id="filter-ciudad-sur" class="btn filter" data-zone="Sur">Sur</button>
        <button id="filter-centro" class="btn filter" data-zone="Central">Central</button>
    </div>

    <div class="toolbar">
        <button id="btn-save-last" class="btn save" disabled>Guardar √∫ltimo dibujo</button>
        <button id="btn-undo-delete" class="btn undo" disabled>Deshacer √∫ltimo borrado</button>
        <button id="btn-export" class="btn export">Exportar</button>
        <label class="btn import" for="file-import">Importar GeoJSON</label>
        <input id="file-import" type="file" accept="application/geo+json,application/json,.geojson,.json" style="display:none">
        <button id="btn-clear" class="btn clear">Borrar edici√≥n</button>
    </div>

    <div id="map"></div>

    <div class="legend">
        <h4>Clasificaci√≥n UDP</h4>
        <div class="legend-row"><span class="legend-chip chip-mixta"></span> UDP Mixta</div>
        <div class="legend-row"><span class="legend-chip chip-comercial"></span> UDP Comercial</div>
        <div class="legend-row"><span class="legend-chip chip-residencial"></span> UDP Residencial</div>
        <div class="legend-row"><span class="legend-chip chip-ambiental"></span> UDP Ambiental</div>
        <h4 style="margin-top:10px;">Edici√≥n / Guardado</h4>
        <div class="legend-row"><span class="legend-chip" style="border-color:#0ea5e9; background:rgba(14,165,233,.15)"></span> Guardado</div>
        <div class="legend-row"><span class="legend-chip" style="border-color:#22c55e; background:rgba(34,197,94,.15)"></span> En Edici√≥n</div>
    </div>

    <script>
        // Coordenadas del centro de Monter√≠a para zoom de reset
        const MONTERIA_CENTER = [8.751, -75.885]; 
        const MONTERIA_ZOOM = 13;

        // =======================
        // 1) MAPA BASE
        // =======================
        const map = L.map('map').setView(MONTERIA_CENTER, MONTERIA_ZOOM);

        const baseOSM = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);
        const baseSat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri'
        });

        const layerControl = L.control.layers(
            { 'Mapa': baseOSM, 'Sat√©lite': baseSat },
            null, { collapsed: true }
        ).addTo(map);

        // =================================================================================================
        // 2) CAPA DE L√çMITES UDP (¬°DATOS ACTUALIZADOS con nombres de Macro-Zona corregidos!)
        // =================================================================================================
        const udpLimitsData = {
            "type": "FeatureCollection",
            "features": [

                // üö© UDP AGREGADA: UDP-5-01 (Macro-Zona ahora es "Sur") üö©
                { "type":"Feature","properties":{"codigo":"UDP-5-01","macro_zona":"Sur", "tipo_udp":"Ambiental", "pdf_url":"pdf/UDP_5-01(PEMP)_EDIFICABILIDAD.pdf"},
                    "geometry":{
                        "type": "Polygon",
                        "coordinates": [
                            [
                              [ -75.881495, 8.759376 ],
                              [ -75.884972, 8.763278 ],
                              [ -75.892096, 8.749069 ],
                              [ -75.890121, 8.750808 ],
                              [ -75.891237, 8.75068 ],
                              [ -75.888362, 8.752292 ],
                              [ -75.88686, 8.750808 ],
                              [ -75.883899, 8.755134 ],
                              [ -75.88553, 8.75594 ],
                              [ -75.88347, 8.758782 ],
                              [ -75.882268, 8.758315 ],
                              [ -75.881495, 8.759376 ]
                            ]
                        ]
                    }
                },
                
                // üö© UDP PREVIAMENTE AGREGADA: UDP-5-02 (Macro-Zona ahora es "Sur") üö©
                { "type":"Feature","properties":{"codigo":"UDP-5-02","macro_zona":"Sur", "tipo_udp":"Residencial", "pdf_url":"pdf/UDP_5-02_EDIFICABILIDAD.pdf"},
                    "geometry":{
                        "type": "Polygon",
                        "coordinates": [
                            [
                              [ -75.884371, 8.742494 ],
                              [ -75.887032, 8.743342 ],
                              [ -75.889692, 8.750977 ],
                              [ -75.89098, 8.750808 ],
                              [ -75.888233, 8.752165 ],
                              [ -75.88686, 8.750638 ],
                              [ -75.88377, 8.755134 ],
                              [ -75.885487, 8.755982 ],
                              [ -75.883427, 8.758612 ],
                              [ -75.882225, 8.758188 ],
                              [ -75.881367, 8.759376 ],
                              [ -75.88377, 8.762175 ],
                              [ -75.8848, 8.763278 ],
                              [ -75.883083, 8.766501 ],
                              [ -75.874586, 8.759206 ],
                              [ -75.884371, 8.742494 ]
                            ]
                        ]
                    }
                },

                // üö© UDP PREVIAMENTE AGREGADA: UDP-8-04-1 (Macro-Zona ahora es "Central") üö©
                { "type":"Feature","properties":{"codigo":"UDP-8-04-1","macro_zona":"Central", "tipo_udp":"Mixta", "pdf_url":"pdf/UDP_8-04-1_EDIFICABILIDAD.pdf"},
                    "geometry":{
                        "type": "Polygon",
                        "coordinates": [
                            [
                              [ -75.874329, 8.759206 ],
                              [ -75.878363, 8.751656 ],
                              [ -75.873384, 8.748517 ],
                              [ -75.870123, 8.743258 ],
                              [ -75.86729, 8.742664 ],
                              [ -75.869522, 8.75488 ],
                              [ -75.874329, 8.759206 ]
                            ]
                        ]
                    }
                },
                
                // üö© UDP PREVIAMENTE AGREGADA: UDP-5-03 (Macro-Zona ahora es "Sur") üö©
                { "type":"Feature","properties":{"codigo":"UDP-5-03","macro_zona":"Sur", "tipo_udp":"Mixta", "pdf_url":"pdf/UDP_5-03_EDIFICABILIDAD.pdf"},
                    "geometry":{
                        "type": "Polygon",
                        "coordinates": [
                            [
                              [ -75.884113, 8.742664 ],
                              [ -75.87965, 8.750044 ],
                              [ -75.878706, 8.750723 ],
                              [ -75.878105, 8.751826 ],
                              [ -75.873556, 8.748517 ],
                              [ -75.870295, 8.743088 ],
                              [ -75.875874, 8.742494 ],
                              [ -75.874414, 8.739779 ],
                              [ -75.875702, 8.738761 ],
                              [ -75.878105, 8.741646 ],
                              [ -75.884113, 8.742664 ]
                            ]
                        ]
                    }
                },
                
                // üö© UDP PREVIAMENTE AGREGADA: UDP-6-01 (Macro-Zona ahora es "Sur") üö©
                { "type":"Feature","properties":{"codigo":"UDP-6-01","macro_zona":"Sur", "tipo_udp":"Mixta", "pdf_url":"pdf/UDP_6-01_EDIFICABILIDAD.pdf"},
                    "geometry":{
                        "type": "Polygon",
                        "coordinates": [
                            [
                              [ -75.878105, 8.7419 ],
                              [ -75.883942, 8.742409 ],
                              [ -75.883169, 8.736556 ],
                              [ -75.872784, 8.727733 ],
                              [ -75.873642, 8.731126 ],
                              [ -75.869265, 8.742918 ],
                              [ -75.875788, 8.742409 ],
                              [ -75.874329, 8.740034 ],
                              [ -75.875444, 8.738761 ],
                              [ -75.878105, 8.7419 ]
                            ]
                        ]
                    }
                },

                // üö© UDP CORREGIDA: UDP-6-02 (Macro-Zona ahora es "Sur") üö©
                { "type":"Feature","properties":{"codigo":"UDP-6-02","macro_zona":"Sur", "tipo_udp":"Ambiental", "pdf_url":"pdf/UDP_6-02_EDIFICABILIDAD.pdf"},
                    "geometry":{
                        "type": "Polygon",
                        "coordinates": [
                            [
                              [ -75.853472, 8.736216 ],
                              [ -75.855532, 8.733586 ],
                              [ -75.854931, 8.732653 ],
                              [ -75.860682, 8.727733 ],
                              [ -75.859394, 8.726715 ],
                              [ -75.866432, 8.723236 ],
                              [ -75.872526, 8.728072 ],
                              [ -75.87347, 8.731296 ],
                              [ -75.868921, 8.742833 ],
                              [ -75.859137, 8.739695 ],
                              [ -75.853472, 8.736216 ]
                            ]
                        ]
                    }
                },
                
                // üö© UDP PREVIAMENTE AGREGADA: UDP-7-01 (Macro-Zona ahora es "Sur") üö©
                { "type":"Feature","properties":{"codigo":"UDP-7-01","macro_zona":"Sur", "tipo_udp":"Mixta", "pdf_url":"pdf/UDP_7-01_EDIFICABILIDAD.pdf"},
                    "geometry":{
                        "type": "Polygon",
                        "coordinates": [
                            [
                              [ -75.870552, 8.769046 ],
                              [ -75.869222, 8.768325 ],
                              [ -75.874071, 8.759248 ],
                              [ -75.883083, 8.766968 ],
                              [ -75.880423, 8.772439 ],
                              [ -75.876174, 8.770827 ],
                              [ -75.87317, 8.768113 ],
                              [ -75.870552, 8.769046 ]
                            ]
                        ]
                    }
                },
                
                // üö© UDP PREVIAMENTE AGREGADA: UDP-8-01 (Macro-Zona ahora es "Sur") üö©
                { "type":"Feature","properties":{"codigo":"UDP-8-01","macro_zona":"Sur", "tipo_udp":"Residencial", "pdf_url":"pdf/UDP_8-01_EDIFICABILIDAD.pdf"},
                    "geometry":{
                        "type": "Polygon",
                        "coordinates": [
                            [
                                [ -75.862741, 8.795087 ],
                                [ -75.85536, 8.791864 ],
                                [ -75.86935, 8.768367 ],
                                [ -75.870466, 8.769046 ],
                                [ -75.869694, 8.7721 ],
                                [ -75.87347, 8.783297 ],
                                [ -75.872955, 8.784654 ],
                                [ -75.862741, 8.795087 ]
                            ]
                        ]
                    }
                },
                
                // --- UDPs ANTERIORMENTE AGREGADAS O ACTUALIZADAS ---

                // UDP 12-01 (Macro-Zona ahora es "Oriente")
                { "type":"Feature","properties":{"codigo":"UDP-12-01","macro_zona":"Oriente", "tipo_udp":"Mixta", "pdf_url":"pdf/UDP_12-01_EDIFICABILIDAD.pdf"},
                    "geometry":{"type":"Polygon","coordinates":[[ [-75.846262,8.755813],[-75.840254,8.754286],[-75.840511,8.75225],[-75.838881,8.75191],[-75.83931,8.749959],[-75.848408,8.749366],[-75.849695,8.751232],[-75.848837,8.753862],[-75.846262,8.755813] ]]}
                },
                // UDP 1-01 (Macro-Zona ahora es "Occidente")
                { "type":"Feature","properties":{"codigo":"UDP-1-01","macro_zona":"Occidente", "tipo_udp":"Residencial", "pdf_url":"docs/udp-1-01.pdf"},
                    "geometry":{"type":"Polygon","coordinates":[[ [-75.906429,8.742409],[-75.918274,8.753437],[-75.896988,8.773966],[-75.891151,8.768367],[-75.899391,8.754286],[-75.893211,8.747499],[-75.900936,8.749196],[-75.906429,8.742409] ]]}
                },
                // UDP 2-01 (Macro-Zona ahora es "Occidente")
                { "type":"Feature","properties":{"codigo":"UDP-2-01","macro_zona":"Occidente", "tipo_udp":"Ambiental", "pdf_url":"docs/udp-2-01.pdf"},
                    "geometry":{"type":"Polygon","coordinates":[[ [-75.892868,8.747669],[-75.880508,8.772439],[-75.882912,8.784315],[-75.8848,8.782788],[-75.886688,8.783636],[-75.891151,8.776002],[-75.891666,8.768707],[-75.899391,8.753777],[-75.892868,8.747669] ]]}
                },
                // UDP 3-01 (Macro-Zona ahora es "Occidente")
                { "type":"Feature","properties":{"codigo":"UDP-3-01","macro_zona":"Occidente", "tipo_udp":"Comercial", "pdf_url":"pdf/UDP_3-01_EDIFICABILIDAD.pdf"},
                    "geometry":{"type":"Polygon","coordinates":[[ [-75.905399,8.743088],[-75.907545,8.739355],[-75.902052,8.740797],[-75.893726,8.745463],[-75.888147,8.737998],[-75.887203,8.743173],[-75.889692,8.750808],[-75.893383,8.747754],[-75.901108,8.749026],[-75.905399,8.743088] ]]}
                },
                // UDP 3-02 (Macro-Zona ahora es "Occidente")
                { "type":"Feature","properties":{"codigo":"UDP-3-02","macro_zona":"Occidente", "tipo_udp":"Mixta", "pdf_url":"pdf/UDP_3-02_EDIFICABILIDAD.pdf"},
                    "geometry":{"type":"Polygon","coordinates":[[ [-75.907545,8.739355],[-75.90188,8.740882],[-75.899048,8.729938],[-75.8957,8.732738],[-75.894585,8.732653],[-75.892954,8.733841],[-75.891581,8.733162],[-75.892611,8.732314],[-75.889692,8.730108],[-75.88892,8.732993],[-75.888062,8.738083],[-75.893555,8.745209],[-75.907545,8.739355] ]]}
                },
                // UDP 4-02 (Macro-Zona ahora es "Sur")
                { "type":"Feature","properties":{"codigo":"UDP-4-02","macro_zona":"Sur", "tipo_udp":"Residencial", "pdf_url":"docs/udp-4-02.pdf"},
                    "geometry":{"type":"Polygon","coordinates":[[ [-75.877419,8.72154],[-75.882225,8.725442],[-75.880165,8.727309],[-75.882568,8.729854],[-75.885658,8.727818],[-75.889606,8.730023],[-75.892525,8.732059],[-75.891666,8.733926],[-75.893555,8.734774],[-75.899391,8.729854],[-75.89819,8.727478],[-75.895443,8.7268],[-75.893383,8.722897],[-75.889778,8.716958],[-75.898361,8.717128],[-75.898018,8.714074],[-75.894756,8.714752],[-75.89201,8.712547],[-75.889606,8.714752],[-75.886345,8.712716],[-75.877419,8.72154] ]]}
                },
                // UDP 4-01 (Macro-Zona ahora es "Sur")
                { "type":"Feature","properties":{"codigo":"UDP-4-01","macro_zona":"Sur", "tipo_udp":"Comercial", "pdf_url":"docs/udp-4-01.pdf"},
                    "geometry":{"type":"Polygon","coordinates":[[ [-75.866261,8.722897],[-75.874329,8.728496],[-75.883255,8.736301],[-75.883942,8.74207],[-75.887547,8.743088],[-75.890121,8.729684],[-75.892525,8.732229],[-75.891495,8.734435],[-75.893898,8.735113],[-75.899563,8.729514],[-75.898361,8.726969],[-75.893211,8.723236],[-75.888062,8.728666],[-75.88274,8.729684],[-75.880508,8.727818],[-75.882225,8.725612],[-75.876389,8.720691],[-75.874157,8.718655],[-75.869522,8.718825],[-75.866261,8.722897] ]]}
                },

                // üö© UDPs ORIGINALES (Macro-Zonas renombradas) üö©

                // UDP 10-01 (Macro-Zona ahora es "Central")
                { "type":"Feature","properties":{"codigo":"UDP-10-01","macro_zona":"Central", "tipo_udp":"Comercial", "pdf_url":"docs/udp-10-01.pdf"},
                    "geometry":{"type":"Polygon","coordinates":[[ [-75.854244,8.82965],[-75.851626,8.83088],[-75.843859,8.826003],[-75.841541,8.827699],[-75.840769,8.827148],[-75.840168,8.82842],[-75.839267,8.827827],[-75.840297,8.825537],[-75.836349,8.823798],[-75.835748,8.821126],[-75.835018,8.82172],[-75.832658,8.819515],[-75.833859,8.818539],[-75.835576,8.820617],[-75.838537,8.816589],[-75.843601,8.820236],[-75.844846,8.822992],[-75.849824,8.824646],[-75.854244,8.82965] ]]}
                },
                // UDP 9-01 (Macro-Zona ahora es "Occidente")
                { "type":"Feature","properties":{"codigo":"UDP-9-01","macro_zona":"Occidente", "tipo_udp":"Residencial", "pdf_url":"pdf/UDP_9-01_EDIFICABILIDAD.pdf"},
                    "geometry":{"type":"Polygon","coordinates":[[ [-75.847292,8.810864],[-75.849695,8.811457],[-75.849953,8.8101],[-75.854588,8.811627],[-75.855017,8.810694],[-75.858965,8.811372],[-75.860424,8.809167],[-75.861969,8.809252],[-75.858622,8.80094],[-75.86257,8.795087],[-75.855703,8.792288],[-75.850554,8.800516],[-75.847292,8.810864] ]]}
                },
                // UDP 9-02 (Macro-Zona ahora es "Occidente")
                { "type":"Feature","properties":{"codigo":"UDP-9-02","macro_zona":"Occidente", "tipo_udp":"Residencial", "pdf_url":"docs/udp-9-02.pdf"},
                    "geometry":{"type":"Polygon","coordinates":[[ [-75.847034,8.810779],[-75.844803,8.810015],[-75.843687,8.810864],[-75.841885,8.808998],[-75.839481,8.808319],[-75.839396,8.806368],[-75.838366,8.806792],[-75.840597,8.802382],[-75.840425,8.801279],[-75.842314,8.800176],[-75.843515,8.801194],[-75.850124,8.800346],[-75.847034,8.810779] ]]}
                },
                // UDP 8-02 (Macro-Zona ahora es "Sur")
                { "type":"Feature","properties":{"codigo":"UDP-8-02","macro_zona":"Sur", "tipo_udp":"Ambiental", "pdf_url":"docs/udp-8-02.pdf"},
                    "geometry":{"type":"Polygon","coordinates":[[ [-75.851154,8.799243],[-75.864029,8.776171],[-75.850811,8.769216],[-75.845661,8.778547],[-75.837078,8.786011],[-75.843086,8.789743],[-75.845318,8.788216],[-75.846863,8.79127],[-75.841541,8.793306],[-75.838795,8.794324],[-75.843086,8.8006],[-75.851154,8.799243] ]]}
                },
                // UDP 8-03 (Macro-Zona ahora es "Sur")
                { "type":"Feature","properties":{"codigo":"UDP-8-03","macro_zona":"Sur", "tipo_udp":"Mixta", "pdf_url":"pdf/UDP_8-03_EDIFICABILIDAD.pdf"},
                    "geometry":{"type":"Polygon","coordinates":[[ [-75.853987,8.770912],[-75.856905,8.768791],[-75.860081,8.759545],[-75.868235,8.751401],[-75.869522,8.755389],[-75.873814,8.759291],[-75.864801,8.776596],[-75.853987,8.770912] ]]}
                },
                // UDP 8-04 (Macro-Zona ahora es "Central")
                { "type":"Feature","properties":{"codigo":"UDP-8-04","macro_zona":"Central", "tipo_udp":"Comercial", "pdf_url":"pdf/UDP_8-04_EDIFICABILIDAD.pdf"},
                    "geometry":{"type":"Polygon","coordinates":[[ [-75.862055,8.757679],[-75.857506,8.755049],[-75.860682,8.75225],[-75.862656,8.750553],[-75.859652,8.749535],[-75.859566,8.750808],[-75.855017,8.748263],[-75.855618,8.745887],[-75.852442,8.741985],[-75.851927,8.738846],[-75.853386,8.736386],[-75.858235,8.739949],[-75.866947,8.742197],[-75.867548,8.746396],[-75.868235,8.750977],[-75.862055,8.757679] ]]}
                }
            ]
        };

        // FUNCI√ìN DE ESTILO: Asigna color seg√∫n el tipo_udp y el filtro activo
        function stylePorUDP(feature, currentFilter = 'All') {
            const macroZone = feature.properties?.macro_zona;
            const tipoUDP = feature.properties?.tipo_udp;

            if (!macroZone || !tipoUDP) {
                console.error("Advertencia: Feature GeoJSON no tiene 'macro_zona' o 'tipo_udp' definido.", feature.properties);
                return { color: '#dc3545', weight: 1, opacity: 1, fillOpacity: 0.1 }; 
            }

            // La clave de la correcci√≥n: la zona del GeoJSON debe COINCIDIR con la zona del filtro (data-zone)
            const isMatch = (currentFilter === 'All' || macroZone === currentFilter);
            
            let color;
            switch (tipoUDP) {
                case 'Mixta': color = 'var(--udp-mixta)'; break;
                case 'Comercial': color = 'var(--udp-comercial)'; break;
                case 'Residencial': color = 'var(--udp-residencial)'; break;
                case 'Ambiental': color = 'var(--udp-ambiental)'; break;
                default: color = '#6c757d'; 
            }

            if (isMatch) {
                return { 
                    color: color, 
                    weight: 2.5, 
                    opacity: 1, 
                    fillOpacity: 0.5 
                };
            } else {
                return { 
                    color: '#888', 
                    weight: 1, 
                    opacity: 0.2, 
                    fillOpacity: 0.02 
                };
            }
        }

        // FUNCI√ìN PARA GENERAR EL CONTENIDO DEL POPUP
        function createPopupContent(properties) {
            const codigo = properties.codigo || 'N/A';
            const macroZone = properties.macro_zona || 'N/A';
            const tipoUDP = properties.tipo_udp || 'N/A';
            const pdfUrl = properties.pdf_url; 

            let content = `
                <div class="udp-popup">
                    <h4>Detalles de la UDP</h4>
                    <p><strong>C√≥digo:</strong> ${codigo}</p>
                    <p><strong>Macro-Zona:</strong> ${macroZone}</p>
                    <p><strong>Clasificaci√≥n:</strong> ${tipoUDP}</p>
            `;
            
            if (pdfUrl) {
                content += `<a href="${pdfUrl}" target="_blank" class="btn-pdf-popup">Ver Documento PDF</a>`;
            } else {
                content += `<p style="color:#ef4444;">Sin documento asociado.</p>`;
            }

            content += `</div>`;
            return content;
        }

        let udpLimitsLayer = null;
        if (udpLimitsData.features && udpLimitsData.features.length) {
            map.createPane('udp-limits-pane');
            map.getPane('udp-limits-pane').style.zIndex = 650;

            udpLimitsLayer = L.geoJSON(udpLimitsData, {
                pane: 'udp-limits-pane',
                style: (f) => stylePorUDP(f, 'All'),
                onEachFeature: (f, layer)=>{
                    // Uso de bindPopup para mostrar datos y el bot√≥n del PDF
                    const popupContent = createPopupContent(f.properties);
                    layer.bindPopup(popupContent);
                }
            }).addTo(map);
            layerControl.addOverlay(udpLimitsLayer, 'L√≠mites UDP (Por Tipo)');

            try {
                // Ajusta el mapa para ver todos los nuevos pol√≠gonos
                const b = udpLimitsLayer.getBounds();
                if (b.isValid()) map.fitBounds(b.pad(0.06));
            } catch(_) {}
        } else {
            map.setView(MONTERIA_CENTER, MONTERIA_ZOOM);
        }

        // =======================
        // 3) FUNCIONALIDAD DE BOTONES DE FILTRO (Macro-zonas)
        // =======================
        const filterButtons = document.querySelectorAll('#filter-toolbar .btn.filter');

        function filterMapByZone(zoneName) {
            if (!udpLimitsLayer) return;

            let targetBounds = null;

            udpLimitsLayer.eachLayer(layer => {
                const macroZone = layer.feature.properties?.macro_zona;
                
                layer.setStyle(stylePorUDP(layer.feature, zoneName));

                const isMatch = (zoneName === 'All' || macroZone === zoneName);
                if (isMatch) {
                    if (!targetBounds) {
                        targetBounds = layer.getBounds();
                    } else {
                        targetBounds.extend(layer.getBounds());
                    }
                }
            });

            if (targetBounds && targetBounds.isValid()) {
                map.fitBounds(targetBounds.pad(0.06));
            } else if (zoneName === 'All' && udpLimitsLayer.getBounds().isValid()) {
                map.fitBounds(udpLimitsLayer.getBounds().pad(0.06));
            } else if (zoneName !== 'All') {
                console.warn(`No se encontraron pol√≠gonos para la zona: ${zoneName}`);
                map.setView(MONTERIA_CENTER, MONTERIA_ZOOM);
            }
        }

        filterButtons.forEach(button => {
            button.addEventListener('click', function() {
                filterButtons.forEach(b => b.classList.remove('active'));
                this.classList.add('active');

                const zone = this.dataset.zone;
                filterMapByZone(zone);
            });
        });

        // =======================
        // 4) DIBUJOS Y PERSISTENCIA (Edici√≥n, Guardado, Undo, Import/Export)
        // =======================
        const drawnItems = new L.FeatureGroup().addTo(map);  
        const savedItems = new L.FeatureGroup().addTo(map);  
        layerControl.addOverlay(drawnItems, 'Dibujos (edici√≥n)');
        layerControl.addOverlay(savedItems, 'Guardados');

        const LS_KEY_DRAWN = 'monteria_drawn_polygons';
        const LS_KEY_SAVED = 'monteria_saved_polygons';
        const btnSaveLast = document.getElementById('btn-save-last');
        const btnUndo     = document.getElementById('btn-undo-delete');
        const btnExport   = document.getElementById('btn-export');
        const btnClear    = document.getElementById('btn-clear');
        const fileImport  = document.getElementById('file-import');

        let lastDrawnLayer = null;      
        const undoStack = [];           

        function saveGroupToLS(group, key) {
            const gj = group.toGeoJSON();
            localStorage.setItem(key, JSON.stringify(gj));
        }
        function savedStyle(){ return { color:'var(--cyan)', weight:2.5, fillOpacity:.15 }; }
        function loadGroupFromLS(group, key, styleFn) {
            try {
                const raw = localStorage.getItem(key);
                if (!raw) return;
                const gj = JSON.parse(raw);
                L.geoJSON(gj, styleFn ? { style: styleFn } : undefined)
                    .eachLayer(l => group.addLayer(l));
            } catch(e) {
                console.warn('No se pudo cargar', key, e);
            }
        }

        loadGroupFromLS(drawnItems, LS_KEY_DRAWN);  
        loadGroupFromLS(savedItems, LS_KEY_SAVED, savedStyle); 

        const drawControl = new L.Control.Draw({
            edit: { featureGroup: drawnItems, edit: true, remove: true },
            draw: {
                polygon: {
                    allowIntersection: false,
                    showArea: true,
                    shapeOptions: { color:'var(--ok)', weight:2, fillOpacity:.15 }
                },
                polyline:false, rectangle:false, marker:false, circle:false, circlemarker:false
            }
        });
        map.addControl(drawControl);

        map.on(L.Draw.Event.CREATED, e => {
            drawnItems.addLayer(e.layer);
            lastDrawnLayer = e.layer;
            btnSaveLast.disabled = false;
            saveGroupToLS(drawnItems, LS_KEY_DRAWN);
        });
        map.on(L.Draw.Event.EDITED, () => saveGroupToLS(drawnItems, LS_KEY_DRAWN));
        map.on(L.Draw.Event.DELETED, e => {
            const deleted = [];
            e.layers.eachLayer(l => deleted.push(l.toGeoJSON()));
            if (deleted.length){
                undoStack.push(deleted);
                btnUndo.disabled = false;
            }
            saveGroupToLS(drawnItems, LS_KEY_DRAWN);
        });

        function moveLayerToSaved(layer){
            try { drawnItems.removeLayer(layer); } catch(_){}
            const gj = layer.toGeoJSON();
            const newLayer = L.geoJSON(gj, { style: savedStyle }).getLayers()[0];
            savedItems.addLayer(newLayer);
            saveGroupToLS(drawnItems, LS_KEY_DRAWN);
            saveGroupToLS(savedItems, LS_KEY_SAVED);
        }

        btnSaveLast.addEventListener('click', ()=>{
            if (!lastDrawnLayer){
                const layers = Object.values(drawnItems._layers || {});
                if (layers.length) lastDrawnLayer = layers[layers.length-1];
            }
            if (!lastDrawnLayer){
                alert('Dibuja un pol√≠gono primero.');
                return;
            }
            moveLayerToSaved(lastDrawnLayer);
            lastDrawnLayer = null;
            btnSaveLast.disabled = true;
            alert('¬°Pol√≠gono guardado!');
        });

        btnUndo.addEventListener('click', ()=>{
            if (!undoStack.length) return;
            const last = undoStack.pop(); 
            last.forEach(f=>{
                const restored = L.geoJSON(f, { style:{ color:'var(--ok)', weight:2, fillOpacity:.15 } }).getLayers()[0];
                drawnItems.addLayer(restored);
            });
            saveGroupToLS(drawnItems, LS_KEY_DRAWN);
            if (!undoStack.length) btnUndo.disabled = true;
        });

        btnExport.addEventListener('click', ()=>{
            const payload = {
                saved: savedItems.toGeoJSON(),
                drawn: drawnItems.toGeoJSON()
            };
            const url = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(payload, null, 2));
            const a = document.createElement('a');
            a.href = url; a.download = 'poligonos_monteria.geojson';
            a.click();
        });

        fileImport.addEventListener('change', async (ev)=>{
            const f = ev.target.files?.[0];
            if (!f) return;
            try{
                const text = await f.text();
                const gj = JSON.parse(text);
                L.geoJSON(gj, { style: savedStyle }).eachLayer(l => savedItems.addLayer(l));
                saveGroupToLS(savedItems, LS_KEY_SAVED);
                alert('GeoJSON importado en "Guardados".');
            }catch(e){
                alert('Archivo inv√°lido o corrupto.');
            }finally{
                ev.target.value = '';
            }
        });

        btnClear.addEventListener('click', ()=>{
            if (!confirm('¬øBorrar TODOS los pol√≠gonos en edici√≥n? (los guardados permanecen)')) return;
            drawnItems.clearLayers();
            saveGroupToLS(drawnItems, LS_KEY_DRAWN);
        });

    </script>
</body>
</html>